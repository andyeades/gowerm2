<?php
/**
 * FME Extensions
 *
 * NOTICE OF LICENSE
 *
 * This source file is subject to the fmeextensions.com license that is
 * available through the world-wide-web at this URL:
 * https://www.fmeextensions.com/LICENSE.txt
 *
 * DISCLAIMER
 *
 * Do not edit or add to this file if you wish to upgrade this extension to newer
 * version in the future.
 *
 * @category FME
 * @package FME_Productattachments
 * @copyright Copyright (c) 2019 FME (http://fmeextensions.com/)
 * @license https://fmeextensions.com/LICENSE.txt
 */

$objectManager = \Magento\Framework\App\ObjectManager::getInstance();
$_product = $objectManager->get('Magento\Framework\Registry')->registry('current_product');//get current product


$session = $objectManager->create('Magento\Customer\Model\Session');
$moduleManager = $objectManager->get('\Magento\Framework\Module\Manager');



if ($moduleManager->isOutputEnabled('FME_Productattachments')) {
/** @var FME\Productattachments\Helper\Data $_helper */
$_helper = $objectManager->create('FME\Productattachments\Helper\Data');
$categoriesCollection = $_helper->getAllCategories();




$_customerGroupId = $session->getCustomerGroupId();

$blockTitle = $_helper->getProductPageAttachmentHeading();

//$_helper = $objectManager->create('FME\Productattachments\Helper\Data'); ?>
<div class="box-collateral">
    <?php if ($this->getBlockMainTitle()): ?>
        <h2><?php /** @noEscape */ echo $this->getBlockMainTitle(); ?></h2>
    <?php endif; ?>
    <div class="pa_category">
        <?php foreach ($categoriesCollection as $category) { ?>
            <?php

            $hasData = $_helper->getProductRelatedAttachments(null, $category->getCategoryId(),$_product->getId());
            //echo '<pre>';print_r($hasData->getData());exit;
            ?>

            <?php if (count($hasData) > 0): ?>
                <!--<h2><?php /** @noEscape */ echo trim($category->getCategoryName()) ?></h2>--><h2>Assembly Manuals</h2>
                <p class="prod-desc-intab std">To make things that little bit easier, you can find comprehensive instructions for your chosen product within this section. In case you need any more help or assistance, please don't hesitate to
                    <a class="alt-link alt-link-bold" href="/customer-service">get in touch</a>.</p>
                <div class="pa_attachments">
                    <div class="row">

                        <?php //fetch collection by category id  ?>
                        <?php foreach ($_helper->getProductRelatedAttachments(null, $category->getCategoryId(), $_product->getId()) as $item): ?>
                            <?php
                            $userArray=explode(',', $item['customer_group_id']);

                            if ($session->isLoggedIn()){
                                $customerGroup = $session->getCustomer()->getGroupId();
                            } else {
                                $customerGroup = 0;
                            }
                            ?>
                            <?php //if ($item->getDownloadLink() != ''):
                            $ext = pathinfo($item['filename'], PATHINFO_EXTENSION);
                            $icon = $this->getnewicon($item['file_type']);
                            if($icon){
                                $item['file_icon'] = $icon;
                            }
                            else{

                            }
                            if (in_array($customerGroup, $userArray)) {
                                ?>

                                <div class="col-md-4 col-xs-6">
                                    <?php

                                    $file_icon = str_replace('.gif', '.png', $item['file_icon']);
                                    $file_icon = str_replace('src="','class="lazyload" src="/media/loader.jpg" data-src="', $file_icon);

                                    // check if file is attached
                                    if ($item['file_size'] > 0) {
                                        //check download limit
                                        if ($item['limit_downloads'] != "" && $item['limit_downloads'] != 0) {
                                            if ($item['downloads'] == $item['limit_downloads']) {
                                                echo '<a class="downloadlink" href="javascript:;" onclick="alert(\'You can not download because this attachment excceds the number of download\');"><div class="content-wrap">' . $file_icon . '&nbsp;<b>' . $item['title'] . '</b> <span class="prod-attach-size">Size: (' . $item['file_size'] . ')</span></div></a> ';
                                            }
                                            else {
                                                if(($ext == 'pdf' || $ext == 'PDF') && $_helper->ispro_pdflink()){
                                                    echo '<a class="downloadlink" id="'.$item['productattachments_id'].'" counter="' . $_helper->getStoreManager()->getStore()->getUrl('productattachments') . 'index/counter?id=' . $item['productattachments_id'] . '" href="' . $item['download_link'] . '">' . $item['file_icon'] . '&nbsp;<b>' . $item['title'] . '</b></a>  Size: (' . $item['file_size'] . ')';
                                                }else{
                                                    echo '<a class="downloadlink" id="'.$item['productattachments_id'].'" counter="' . $_helper->getStoreManager()->getStore()->getUrl('productattachments') . 'index/counter?id=' . $item['productattachments_id'] . '" href="' . $_helper->getStoreManager()->getStore()->getUrl('productattachments') . 'index/download?id=' . $item['productattachments_id'] . '"><div class="content-wrap">' . $file_icon . '&nbsp;<b>' . $item['title'] . '</b>  <span class="prod-attach-size">Size: (' . $item['file_size'] . ')</span></div></a>';
                                                }
                                            }
                                        }
                                        else {
                                            if(($ext == 'pdf' || $ext == 'PDF') && $_helper->ispro_pdflink()){
                                                echo '<a class="downloadlink" id="'.$item['productattachments_id'].'" counter="' . $_helper->getStoreManager()->getStore()->getUrl('productattachments') . 'index/counter?id=' . $item['productattachments_id'] . '" href="' . $item['download_link'] . '"><div class="content-wrap">' . $file_icon . '&nbsp;<b>' . $item['title'] . '</b>  <span class="prod-attach-size">Size: (' . $item['file_size'] . ')</span></div></a>';
                                            }else{
                                                echo '<a class="downloadlink" id="'.$item['productattachments_id'].'" counter="' . $_helper->getStoreManager()->getStore()->getUrl('productattachments') . 'index/counter?id=' . $item['productattachments_id'] . '" href="' . $_helper->getStoreManager()->getStore()->getUrl('productattachments') . 'index/download?id=' . $item['productattachments_id'] . '"><div class="content-wrap">' . $file_icon . '&nbsp;<b>' . $item['title'] . '</b>  <span class="prod-attach-size">Size: (' . $item['file_size'] . ')</span></div></a>';
                                            }
                                        }

                                        if ($_helper->getScopeConfig()->getValue('productattachments/general/show_counter')) {
                                            /** @noEscape */ echo '&nbsp;&nbsp;' . __('Downloads: ' . '<span id="item_counter_'.$item['productattachments_id'].'">'. $item['downloads'].'</span>');
                                        }
                                    } else {
                                        /** @noEscape */ echo '<b>' . $item['title'] . '</b>';
                                    }
                                    ?>

                                    <?php if ($_helper->getScopeConfig()->getValue('productattachments/productattachments/showcontent')): ?>
                                        <?php if (isset($item['content']) && $item['content'] != ''): ?>
                                            <br /><?php /** @noEscape */  echo $item['content']; ?><br />
                                        <?php endif; ?>
                                    <?php endif; ?>
                                </div>
                                <?php if ($item->getLinkUrl() != ''): ?>
                                    <?php
                                    $linkTitle = 'Go To';
                                    if ($item->getLinkTitle() != '') {
                                        $linkTitle = trim($item->getLinkTitle());
                                    }
                                    ?>
                                    <li>
                                        <a href="<?php /** @noEscape */  echo $item->getLinkUrl() ?>">
                                            <img src="<?php /** @noEscape */  echo $this->getViewFileUrl('FME_Productattachments::images/link.jpg') ?>" width="18"/>&nbsp;<?php echo __($linkTitle) ?>
                                        </a>
                                    </li>
                                <?php endif; ?>
                                <?php if ($item->getEmbedVideo() != ''): ?>
                                    <?php $vidTitle = trim($item->getVideoTitle()); ?>
                                    <li>
                                        <a href="<?php /** @noEscape */  echo $item->getEmbedVideo(); ?>" rel="prettyPhoto" title="<?php echo $vidTitle ?>">
                                            <img src="<?php /** @noEscape */  echo $this->getViewFileUrl('FME_Productattachments::images/videoicon.jpeg') ?>"/>&nbsp;<?php echo ($vidTitle != '') ? $vidTitle : ''; ?>
                                        </a>
                                    </li>
                                <?php endif; ?>
                            <?php } ?>
                        <?php endforeach; ?>
                    </div>
                </div>
            <?php endif; ?>
        <?php } ?>
    </div>

    <script type="text/javascript" charset="utf-8">

        require(["jquery", "prettyphoto"], function($){
            // plugin code
            // where $ == "jquery"
            $(document).ready(function () {

                $("a[rel^='prettyPhoto']").prettyPhoto({
                    animation_speed: 'fast',
                    slideshow: 10000,
                    hideflash: true,
                    theme: 'pp_default',
                });

            });
        });

        require(["jquery"], function($){

            $('.downloadlink').click(function(e){

                e.preventDefault();
                var downloadUrl = $(this).attr('href');

                if(downloadUrl == 'javascript:;'){
                    return;
                }

                window.open(downloadUrl, '_blank');


                var countUrl = $(this).attr('counter');
                var id = $(this).attr('id');
                var current_element = $(this);

                $.ajax({
                    url : countUrl,
                    type : "GET",
                    success : function(data) {

                        var html_counter = parseInt($('#item_counter_'+id).text());
                        var counter = parseInt(data.counter);
                        var limit = parseInt(data.limit);
                        var stop = false;

                        if(counter == html_counter){
                            $('#item_counter_'+id).text(counter+1);
                            if(limit == counter+1){
                                stop = true;
                            }

                        }else{
                            $('#item_counter_'+id).text(counter);
                            if(limit == counter){
                                stop = true;
                            }
                        }

                        if(stop == true){

                            current_element.removeClass("downloadlink");
                            current_element.attr("href", "javascript:;");
                            current_element.attr("onclick", "alert('You can not download because this attachment excceds the number of download')");
                        }


                    }
                });





            });

        });

    </script>
</div>

<?php } ?>
