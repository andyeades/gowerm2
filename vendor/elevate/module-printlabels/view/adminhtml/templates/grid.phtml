<style>
  .action-button {
    background-color: #eb5202;
    border-color:     #eb5202;
    color:            #ffffff;
    text-shadow:      1px 1px 0 rgba(0, 0, 0, 0.25);
    border:           1px solid;
    border-radius:    0;
    display:          inline-block;
    font-family:      'Open Sans', 'Helvetica Neue', Helvetica, Arial, sans-serif;
    font-size:        1.4rem;
    font-weight:      600;
    line-height:      1.36;
    padding:          0.6rem 1em 0.6rem;
    text-align:       center;
    vertical-align:   baseline;
    cursor:           pointer;
  }

  .action-button:hover {
    background-color: #ba4000;
    border-color:     #b84002;
    box-shadow:       0 0 0 1px #007bdb;
    color:            #ffffff;
    text-decoration:  none;
  }

  .actions-toolbar {
    padding-top: 20px;
  }

  .success-message {
    background-color: #79a22e;
  }

  .error-message {
    background-color: #ee7d7d;
  }

  .excluded td {
    background-color: #ee7d7d !important;
  }
  #order_data_hidden {
    display: none;
  }

  .problem-order-desc {
    margin-bottom: 15px;
  }

  .order-details-top {
    margin-bottom: 20px;
  }

  .order-items {
  }
  .order-item-shrt {
    margin-bottom: 5px;
  }
  .order-item-shrt-child {
    padding-left: 5px;
    padding-top: 5px;
  }
  .addresses-output {
    display: flex;
  }
  .addresses-output > div {
    flex: 0 1 auto;
    width: 50%;
  }
  .addresses-output > div:first-child {
    margin-right: 20px;
  }
  .addresses-output > div:last-child {
    margin-left: 20px;
  }

  .addresses-output .panel-heading {
    text-transform: capitalize;
  }
  .addresses-output .field-title {
    font-weight: 700;
  }

  .order-data-section {
    margin-bottom: 10px;
    display: flex;
  }
  .order-data-section .field-title {
    margin-right: 5px;
  }

  .order-data-section > div {
    flex: 0 1 auto;
  }
  .order-data-section .field-title {
    font-weight: 700;
  }

  .field-title {
    font-weight: 700;
  }

  .order-item-shrt {
    width: 100%;
    clear: both;
  }

  @media only screen and (min-width: 992px) {
    .orders-ship-tb-items {
      width: 450px;
    }
  }

  .loader {
    border: 16px solid #f3f3f3; /* Light grey */
    border-top: 16px solid #3498db; /* Blue */
    border-radius: 50%;
    width: 120px;
    height: 120px;
    animation: spin 2s linear infinite;
    margin: 0 auto;
  }

  @keyframes spin {
    0% {
      transform: rotate(0deg);
    }
    100% {
      transform: rotate(360deg);
  }
  }

  .loading {
    position: fixed;
    z-index: 999;
    height: 2em;
    width: 100%;
    overflow: visible;
    margin: auto;
    top: 0;
    left: 0;
    bottom: 0;
    right: 0;
    display: none;
  }

  .loading:before {
    content: '';
    display: block;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.7);
  }
  .loader-message {

    margin-top: 20px;
    color: #f3f3f3;
    width: 100%;
    margin: 0 auto;
    text-align: center;
    /* z-index: 99999990; */
    font-size: 30px;
    /* background: white; */
    z-index: 1;
    position: relative;
  }

</style>
<div id="message-block"></div>

<?php

$order_data = $this->getOrders();

$orders = $order_data['order_data'];

?>

<div id="actions-toolbar" class="actions-toolbar">
    <?php if ($order_data['order_count'] >= 1) { ?>
  <div id="shipstuff" class="action-button">Ship Orders</div>
  <?php } ?>
  <!--<div id="checkview" class="action-button" data-order-id="785">View Order</div>-->
</div>
<div class="main-content">
  <div class="admin__data-grid-wrap">
    <form id="main-form">


    <?php if ($order_data['order_count'] >= 1) { ?>
      <table class="data-grid data-grid-draggable" data-role="grid">
        <thead>
        <tr>
          <th class="data-grid-multicheck-cell">
            <span class="data-grid-cell-content">Exclude</span>
          </th>
          <th class="data-grid-th _sortable _draggable">
            <span class="data-grid-cell-content" >ID</span>
          </th>
          <!-- /ko --><!-- ko template: getHeader() -->
          <th class="data-grid-th _sortable _draggable _descend">
            <span class="data-grid-cell-content" >Purchase Date</span>
          </th>
          <!-- /ko --><!-- ko template: getHeader() -->
          <th class="data-grid-th _sortable _draggable">
            <span class="data-grid-cell-content">Ship-to Name</span>
          </th>
          <!-- /ko --><!-- ko template: getHeader() -->
          <th class="data-grid-th _sortable _draggable orders-ship-tb-items">
            <span class="data-grid-cell-content">Items</span>
          </th>
          <th class="data-grid-th _sortable _draggable">
            <span class="data-grid-cell-content" >Grand Total (Purchased)</span>
          </th>

          <th class="data-grid-th _sortable _draggable" >
            <span class="data-grid-cell-content" >Number of Packages</span>
          </th>
          <th class="data-grid-th _sortable _draggable" >
            <span class="data-grid-cell-content" >Weight of Packages</span>
          </th>
          <th class="data-grid-th _sortable _draggable" >
            <span class="data-grid-cell-content" >Delivery Method</span>
          </th>
  <!--
          <th class="data-grid-th _sortable _draggable" >
            <span class="data-grid-cell-content">Status</span>
          </th>
          -->
          <th class="data-grid-th" >
            <span class="data-grid-cell-content" >Action</span>
          </th>
        </tr>
        </thead>
        <tbody>
        <?php echo $order_data['html_output']; ?>
        </tbody>
      </table>
    <?php }  else { ?>
      <div class="no-orders">
        <div class="message message-success success">You have shipped all shippable orders.</div>
      </div>
      <?php } ?>
    </form>
  </div>
</div>

<?php if ($order_data['problem_order_count'] >= 1) { ?>
  <div id="problem-orders-container">
    <h3>Problem Orders</h3>
    <div class="problem-order-desc message message-error">
      These orders may have issues with the shipping address, and will need to be processed manually.
    </div>
    <table class="data-grid data-grid-draggable" data-role="grid">
      <thead>
      <tr>
        <th class="data-grid-th _sortable _draggable">
          <span class="data-grid-cell-content">ID</span>
        </th>
        <!-- /ko --><!-- ko template: getHeader() -->
        <th class="data-grid-th _sortable _draggable _descend">
          <span class="data-grid-cell-content">Purchase Date</span>
        </th>
        <!-- /ko --><!-- ko template: getHeader() -->
        <th class="data-grid-th _sortable _draggable">
          <span class="data-grid-cell-content">Ship-to Name</span>
        </th>
        <!-- /ko --><!-- ko template: getHeader() -->
        <th class="data-grid-th _sortable _draggable orders-ship-tb-items">
          <span class="data-grid-cell-content">Items</span>
        </th>
        <th class="data-grid-th _sortable _draggable">
          <span class="data-grid-cell-content">Grand Total (Purchased)</span>
        </th>

        <th class="data-grid-th _sortable _draggable">
          <span class="data-grid-cell-content">Number of Packages</span>
        </th>
        <th class="data-grid-th _sortable _draggable">
          <span class="data-grid-cell-content">Weight of Packages</span>
        </th>
        <th class="data-grid-th _sortable _draggable">
          <span class="data-grid-cell-content">Problem</span>
        </th>
        <!--
                <th class="data-grid-th _sortable _draggable" >
                  <span class="data-grid-cell-content">Status</span>
                </th>
                -->
        <th class="data-grid-th">
          <span class="data-grid-cell-content">Action</span>
        </th>
      </tr>
      </thead>
      <tbody>
      <?php echo $order_data['problem_orders_html']; ?>
      </tbody>
    </table>

  </div>
<?php } ?>
<div id="ajaxResponse"></div>

<div id="loading-overlay" class="loading">
  <div class="loader"></div>
  <div class="loader-message">Attempting to ship orders...</div>
</div>
<script type="text/javascript">
    require(["jquery"],function($) {

        jQuery('#shipstuff').on('click touchend', (function(){


            jQuery('#message-block').html('');
            jQuery('.loading').show();
            var ajaxRequest;

            // collect data from table
            var input_data = jQuery('input[name="order_id"]');

            var input_data = jQuery('input[name="order_id"]');
            var order_ids = [];
            var excluded_order_ids = [];
            var order_ids = [];
            var data_to_send = {};
            jQuery(input_data).each(function(){
                //console.log(jQuery(this).val());
                order_ids.push(jQuery(this).val());
            });

            if (order_ids === undefined || order_ids.length == 0) {
                // No Orders
                jQuery('#message-block').append('<div data-order_id="'+ order_id + '" class="message message-error error" >' + main_message + ' - '+ order_id + '</div>');
            }



            jQuery.each(order_ids, function(key,value){
                //console.log(key);
                //console.log(value);
              var data_elements = jQuery('[data-row-id="' + value + '"]');
              jQuery(data_elements).each(function(index,value1){
                  if (excluded_order_ids.includes(value)) {
                      return true;
                  }
                  var temp_object = {};
                  if (jQuery(this).is('input')) {
                    if(jQuery(this).is(':checked')) {
                        console.log("CHECKED!");
                        temp_object.exclude = 'yes';
                        excluded_order_ids.push(jQuery(this).attr('data-row-id'));
                        return true;
                    } else {
                        temp_object.exclude = 'no';
                    }
                  }
                  var element_name = jQuery(this).attr('name');
                  var element_val = jQuery(this).val();
                  temp_object[element_name] = element_val;
                  console.log(value1);
                  console.log(jQuery(this).val());
                  console.log(value);
                  var temp_array = [value];
                  temp_array.value = temp_object;

                  if (typeof data_to_send[value] !== 'undefined') {
                      data_to_send[value].push(temp_object);
                  } else {
                      data_to_send[value] = [temp_object];
                  }

                });
            });


            console.log(data_to_send);
            console.log(excluded_order_ids);
            //console.log(order_ids);
            var something = {'something':'something'};


            var formdata = jQuery('#main-form').serialize();
            console.log(formdata);
            var arraydata = jQuery('#main-form').serializeArray();
            console.log(arraydata);

            var data_to_send_json = JSON.stringify(data_to_send);
            //console.log(data_to_send_json);

            ajaxRequest = jQuery.ajax({
                url: "<?php echo $this->getUrl('printlabels/test/test'); ?>?isAjax=true",
                type: 'POST',
                data: {
                    form_key: window.FORM_KEY,
                    formdata: arraydata,
                    data_to_send: data_to_send_json,
                    datasend: data_to_send,
                    something: something
                },
                dataType: 'json',
                beforeSend: function () {
                    jQuery('#loader').show();
                },
                success: function(response) {

                    jQuery('.loading').hide();
                    jQuery("#ajaxResponse").html(response);
                    console.log(response);
                    $("#page_order_state").val(response["data"]);
                    const keys = Object.keys(response);
                    const something = Object.values(response);
                    const more = Object.entries(response);

                    for (const somethin of something) {
                        var order_id = somethin.order_id;
                        var overall_success = parseInt(somethin.success);
                        var main_message = somethin.main_message;
                        var no_data = somethin.no_data;

                        if (no_data === 1) {
                            jQuery('#message-block').append('<div class="message message-error error" >' + main_message + '</div>');
                            break;
                        }

                        if (overall_success === 1) {
                            // Success
                            jQuery('#message-block').append('<div data-order_id="'+ order_id + '" class="message message-success success" >' + main_message + ' - '+ order_id + '</div>');
                            // Remove Order From List
                            jQuery('tr[data-order-id='+order_id+']').remove();
                        } else {
                            // Fail ?
                            jQuery('#message-block').append('<div data-order_id="'+ order_id + '" class="message message-error error" >' + main_message + ' - '+ order_id + '</div>');
                        }

                    }
                },
                error: function (xhr, status, errorThrown) {
                    jQuery('.loading').hide();
                    console.log(status);
                    console.log(xhr);
                    console.log(errorThrown);
                }
            });
        }));

        jQuery('.exclude-row').on('click touchend', (function(){
            if (jQuery(this).parents('tr').hasClass('excluded')) {
                jQuery(this).parents('tr').removeClass('excluded');
            } else {
                jQuery(this).parents('tr').addClass('excluded');
            }

        }));



        function getOrders() {
            // Get Orders for Main Bit of Page
            var ajaxRequest;
            ajaxRequest = jQuery.ajax({
                url: "<?php echo $this->getUrl('printlabels/orders/getorders'); ?>?isAjax=true",
                type: 'POST',
                data: {
                    form_key: window.FORM_KEY,
                    formdata: arraydata
                },
                dataType: 'json',
                beforeSend: function () {
                    jQuery('#loader').show();
                },
                success: function(response) {
                    jQuery("#ajaxResponse").html(response);
                    console.log(response);
                    $("#page_order_state").val(response["data"]);
                    const keys = Object.keys(response);
                    const something = Object.values(response);
                    const more = Object.entries(response);

                    for (const somethin of something) {
                        var order_id = somethin.order_id;
                        var success = parseInt(somethin.success);

                        if (success === 1) {
                            // Success
                            jQuery('#message-block').append('<div data-order_id="'+ order_id + '" class="message message-success success" >Order Success - '+ order_id + '</div>');
                        } else {
                            // Fail ?
                            jQuery('#message-block').append('<div data-order_id="'+ order_id + '" class="message message-error error" >Couldn\'t Ship Order  - '+ order_id + '</div>');
                        }

                        console.log(somethin.success);
                        console.log(somethin.order_id);
                        console.log(somethin);
                    }
                },
                error: function (xhr, status, errorThrown) {
                    console.log(status);
                    console.log(xhr);
                    console.log(errorThrown);
                }
            });
        }

        jQuery('.view-order-data').on('click touchend', (function(){

            var other_stuff = jQuery('#modal-content > div').detach();
            jQuery('#order_data_hidden').append(other_stuff);

            var order_id = jQuery(this).attr('data-order-id');
            var order_info = jQuery('#order_data_hidden').find('#order_'+order_id).detach();
            jQuery('#modal-content').append(order_info);
        }));



        jQuery('#checkview').on('click touchend', (function(){
            console.log(this);
            console.log(jQuery(this).attr('data-order-id'));
            // Get Orders for Main Bit of Page
            var ajaxRequest;

            var order_id = jQuery(this).attr('data-order-id');

            ajaxRequest = jQuery.ajax({
                url: "<?php echo $this->getUrl('printlabels/order/viewer'); ?>?isAjax=true",
                type: 'POST',
                data: {
                    form_key: window.FORM_KEY,
                    order_id: order_id
                },
                dataType: 'html',
                beforeSend: function () {
                    jQuery('#loader').show();
                },
                success: function(response) {
                    jQuery("#ajaxResponse").html(response);
                    console.log(response);
                    jQuery("#modal-content").html(response);
                },
                error: function (xhr, status, errorThrown) {
                    console.log(status);
                    console.log(xhr);
                    console.log(errorThrown);
                }
            });
            console.log(ajaxRequest);
        }));
        function getOrderData() {


        }

        $(document).ready(function() {
           jQuery('.shipping_methods').find('.hide-me').hide();

           var shipping_methods = jQuery('.shipping_methods');

           jQuery(shipping_methods).each(function(index,element){

               // Selects Most Likely Best Option?

               var best_option = jQuery(element).find('option[data-networkcode="2^32"]');

               //jQuery(best_option).prop('selected',true);
           });
        });
    });
</script>
<div id="order_data_hidden">
    <?php
    foreach ($orders as $key => $value) { ?>
      <div id="order_<?php echo $key; ?>" class="order_<?php echo $key; ?>"><?php echo $value; ?></div>
    <?php }


    ?>
</div>

<div data-bind="mageInit: {
        'Magento_Ui/js/modal/modal':{
            'type': 'popup',
            'title': 'Order Details',
            'trigger': '[data-trigger=trigger]',
            'responsive': true,
            'buttons': [{
                text: 'Close',
                class: 'action'
            }]
        }}">
  <div id="modal-content" class="content">

  </div>


</div>