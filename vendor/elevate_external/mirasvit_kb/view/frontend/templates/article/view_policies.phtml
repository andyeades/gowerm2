<link rel="stylesheet" type="text/css" href="/js/webforms/opentip/opentip.css" />
<link rel="stylesheet" type="text/css" href="/skin/frontend/base/default/webforms/form.css" media="all" />
<link rel="stylesheet" type="text/css" href="/skin/frontend/base/default/webforms/results.css" media="all" />
<link rel="stylesheet" type="text/css" href="/skin/frontend/base/default/webforms/stars.css" media="all" />

<script type="text/javascript" src="/js/webforms/logic.js"></script>
<script type="text/javascript" src="/js/webforms/dropzone.js"></script>
<script type="text/javascript" src="/js/webforms/opentip/opentip-native-excanvas.min.js"></script>
<script type="text/javascript" src="/js/webforms/multistep.js"></script>

<style>
    .kb-article-view-article {
        background: whitesmoke;
    }

    ul.nav.nav-pills.tabs {
        background-color: #fff;
        margin-top:       30px;
        padding:          10px;
    }

    .nav-pills.tabs li {
        font-size:     15px;
        padding:       13px 10px;
        position:      relative;
        border-bottom: 2px solid #f0f0f0;
        float:         none;
    }

    .nav-pills.tabs li a:hover {
        color: #f0386c;
    }

    .nav-pills.tabs li a {
        padding: 0;
    }

    .kb-article-sections {
        background: #ffffff;
        padding:    30px;
    }

    .nav-pills.tabs li a.active {
        color: #f0386c;
    }

    .kb-article-view-article .kb-article-view-inner {
        margin-top: 30px !important;
    }

</style>

<?php
/** @var \Mirasvit\Kb\Block\Article\View $block */
$article = $block->getArticleByRepo();
$article_id = $article->getArticleId();
$article_categories = $block->getArticle()->getCategories();
$tags = $block->getTags();
$articlesections_obj = $block->getArticleSections($article_id);
$articlesections = $articlesections_obj->getItems();

$article_header_image = '/media/wysiwyg/kbarticles/header-images/' . $article->getArticleHeaderImage();
$article_title = $article->getName();

$helper = $block->getHelper();
//$currentUrl = $this->helper('core/url')->getCurrentUrl();

?>

<article class="kb-article-view-article">
    <header class="kb-article-header">
        <div class="kb-article-header-image" style="background:linear-gradient(rgba(0,107,127,.3),rgba(0,107,127,.3)),url(<?php echo $article_header_image; ?>) no-repeat 50%; background-size:cover;">
            <div class="container">
                <div class="row">
                    <div class="col-xs-12">
                        <div class="flexbox-container">
                            <h1>
                                <?php echo $_article->getName() ?>
                            </h1>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-xs-12 col-sm-6">
                        <div class="kb-categories">
                            <?php $disable_category = 1; ?>
                            <?php if ($disable_category != 1) { ?><?php echo $this->__('Categories:') ?><?php foreach ($categories as $category) { ?>
                                <a class="label happybeds-label" href="<?php echo $category->getUrl() ?>"><?php echo $category->getName() ?></a>
                            <?php } ?><?php } ?>
                        </div>
                    </div>
                    <div class="col-xs-12 col-sm-6">
                        <div class="share-this-block">
                            <div class="share-this-block-inner">


                                <?php $companyname = Mage::app()->getWebsite()->getName(); ?>
                                <?php $emailsubjecttext = "Check Out the " . $article_title . " on the " . $companyname . " Website"; ?>
                                <?php $emailmailto = rawurlencode($emailsubjecttext); ?>
                                <?php $emailbody = rawurlencode($currentUrl); ?>

                                <?php $linktext = $article_title; ?>
                                <?php $the_link = urlencode($linktext); ?>
                                <?php $the_title = urlencode($article_title); ?>
                                <?php $the_url = urlencode($currentUrl); ?>
                                <?php $the_image_url = urlencode($article_header_image); ?>
                                <?php

                                $email_a_friend_on = 0;
                                $pinterest_on = 0;
                                $googleplus_on = 0;

                                ?>

                                <div class="share-this-left">
                                    <i class="share-this-ico fa fa-3x fa-share-alt"></i>
                                    <div class="share-this-title">Share This</div>
                                </div>
                                <div class="share-icons">

                                    <?php if ($email_a_friend_on == 1) { ?>

                                        <a class="share-ico-mail" href="<?php //echo $this->helper('catalog/product')->getEmailToFriendUrl($_product) ?>"><i class="fa fa-envelope"></i></a>
                                    <?php } else { ?>
                                        <a target="_blank" href="mailto:?subject=<?php echo $emailmailto; ?>&body=<?php echo $emailbody; ?>" class="share-ico-mail"><i class="fa fa-envelope"></i></a>
                                    <?php } ?>
                                    <a target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=<?php echo $the_url; ?>" class="soc-ico-fb share-ico-facebook"><i class="fa fa-facebook-f"></i></a>
                                    <?php if ($pinterest_on == 1) { ?>
                                        <a target="_blank" href="http://pinterest.com/pin/create/button/?url=<?php echo $the_url; ?>&media=<?php echo $the_image_url; ?>&description=<?php echo $the_title; ?> " class="pin-it-button" count-layout="horizontal"><i class="fa fa-pinterest"></i></a>
                                    <?php } ?>
                                    <?php if ($googleplus_on == 1) { ?>
                                        <a target="_blank" href="https://plus.google.com/share?url=<? echo $the_url; ?>" class="share-ico-googleplus"><i class="fa fa-google-plus"></i></a>
                                    <?php } ?>

                                    <a target="_blank" href="https://twitter.com/intent/tweet?text=<?php echo $the_link ?>&url=<?php echo $the_url ?>" class="soc-ico-twit share-ico-twitter"><i class="fa fa-twitter"></i></a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div class="container">

        <div class="row">
            <div class="col-xs-12 col-sm-3">
                <ul class="nav nav-pills tabs">
                    <?php $j = 1; ?>
                    <?php foreach ($_articlesections as $articlesection) { ?><?php
                        $articlesection_id = $articlesection->articlesection_id;
                        $articlesubsections = $this->getArticlesubsections($articlesection_id);

                        //                            echo "<pre>";
                        //                                                                              print_r($articlesubsections);
                        //                                                                              die;
                        ?>
                        <li>
                            <a href="#tab-<?php echo $j ?>" <?php if ($j == 1){ ?>class="active"
                                <?php } ?>><?php echo $articlesection->asec_name; ?></a>

                            <ul>
                                <?php foreach ($articlesubsections as $articlesubsection) { ?>
                                    <li><a href="#tab-<?php echo $j ?>_<?php echo $j ?>"><?php echo $articlesubsection->asecsub_name; ?></a>
                                    </li>
                                <?php } ?>
                            </ul>

                            <ul id="ultab-<?php echo $j ?>"></ul>


                        </li>
                        <?php $j++ ?><?php } ?>
                </ul>
            </div>

            <div class="col-xs-12 col-sm-9">
                <div id="kb-article-view-inner" class="kb-article-view-inner">

                    <?php // echo $_article->getTextHtml() ?>
                    <div class="kb-article-sections">

                        <?php $i = 1; ?>
                        <?php foreach ($_articlesections as $articlesection) { ?><?php $url_to_output = $this->getSectionUrl($articlesection->asec_name); ?>


                            <div id="tab-<?php echo $i ?>" class="kb-article-section-inner tab-content" <?php if ($i != 1){ ?>style="display:none;"<?php } ?>>
                                <h2 id="<?php echo $url_to_output; ?>">
                                    <?php echo $articlesection->asec_name; ?>
                                </h2>
                                <?php echo $articlesection->asec_value; ?>
                                <?php
                                $articlesection_id = $articlesection->articlesection_id;
                                $articlesubsections = $this->getArticlesubsections($articlesection_id);

                                ?>

                            </div>

                            <div id="tab-<?php echo $i ?>_<?php echo $i ?>" class="kb-article-section-inner tab-content" <?php if ($i != 1.1){ ?>style="display:none;"<?php } ?>>
                                <?php if ($articlesubsections->count() > 0) { ?>
                                    <div class="kb-article-sub-sections">

                                        <?php foreach ($articlesubsections as $articlesubsection) { ?>

                                            <?php $url_to_output = $this->getSectionUrl($articlesubsection->asecsub_name); ?>

                                            <div class="kb-article-sub-section-inner">
                                                <h3 id="<?php echo $url_to_output; ?>">
                                                    <?php echo $articlesubsection->asecsub_name; ?>
                                                </h3>
                                                <?php echo $articlesubsection->asecsub_value; ?>
                                            </div>
                                        <?php } ?>
                                    </div>
                                <?php } ?>

                            </div>


                            <?php $i++ ?><?php } ?>


                    </div>
                    <div class="row">
                        <div class="kb-categories col-xs-12 col-sm-6">
                            <?php $disable_category = 1; ?>
                            <?php if ($disable_category != 1) { ?><?php echo $this->__('Categories:') ?><?php foreach ($categories as $category) { ?>
                                <a class="label happybeds-label" href="<?php echo $category->getUrl() ?>"><?php echo $category->getName() ?></a>
                            <?php } ?><?php } ?>
                        </div>

                        <div class="kb-share-bottom col-xs-12 col-sm-6">
                            <div class="share-this-block">
                                <div class="share-this-block-inner">
                                    <?php $companyname = Mage::app()->getWebsite()->getName(); ?>
                                    <?php $emailsubjecttext = "Check Out the " . $article_title . " on the " . $companyname . " Website"; ?>
                                    <?php $emailmailto = rawurlencode($emailsubjecttext); ?>
                                    <?php $emailbody = rawurlencode($currentUrl); ?>

                                    <?php $linktext = $article_title; ?>
                                    <?php $the_link = urlencode($linktext); ?>
                                    <?php $the_title = urlencode($article_title); ?>
                                    <?php $the_url = urlencode($currentUrl); ?>
                                    <?php $the_image_url = urlencode($article_header_image); ?>
                                    <?php

                                    $email_a_friend_on = 0;
                                    $pinterest_on = 0;
                                    $googleplus_on = 0;

                                    ?>

                                    <div class="share-this-left">
                                        <i class="share-this-ico fa fa-3x fa-share-alt"></i>
                                        <div class="share-this-title">Share This</div>
                                    </div>
                                    <div class="share-icons">

                                        <?php if ($email_a_friend_on == 1) { ?>

                                            <a class="share-ico-mail" href="<?php //echo $this->helper('catalog/product')->getEmailToFriendUrl($_product) ?>"><i class="fa fa-envelope"></i></a>
                                        <?php } else { ?>
                                            <a target="_blank" href="mailto:?subject=<?php echo $emailmailto; ?>&body=<?php echo $emailbody; ?>" class="share-ico-mail"><i class="fa fa-envelope"></i></a>
                                        <?php } ?>
                                        <a target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=<?php echo $the_url; ?>" class="soc-ico-fb share-ico-facebook"><i class="fa fa-facebook-f"></i></a>
                                        <?php if ($pinterest_on == 1) { ?>
                                            <a target="_blank" href="http://pinterest.com/pin/create/button/?url=<?php echo $the_url; ?>&media=<?php echo $the_image_url; ?>&description=<?php echo $the_title; ?> " class="pin-it-button" count-layout="horizontal"><i class="fa fa-pinterest"></i></a>
                                        <?php } ?>
                                        <?php if ($googleplus_on == 1) { ?>
                                            <a target="_blank" href="https://plus.google.com/share?url=<? echo $the_url; ?>" class="share-ico-googleplus"><i class="fa fa-google-plus"></i></a>
                                        <?php } ?>

                                        <a target="_blank" href="https://twitter.com/intent/tweet?text=<?php echo $the_link ?>&url=<?php echo $the_url ?>" class="soc-ico-twit share-ico-twitter"><i class="fa fa-twitter"></i></a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <?php if ($_tags->count()): ?>
                        <div class="kb-tags">
                            <?php echo __('Tags:') ?>
                            <?php foreach ($_tags as $_tag): ?>
                                <a class="label happybeds-label" href="<?php echo $_tag->getUrl() ?>"><?php echo $_tag->getName() ?></a>&nbsp;
                            <?php endforeach ?>
                        </div>
                    <?php endif ?>

                    <?php if ($this->isRatingEnabled()): ?>
                        <div class="kb-helpful bg-info">
                            <div class="kb-helpful-header-title">Was this article helpful?</div>
                            <?php if (!$this->getVoteResult()): ?>
                                <a class="kb-helpful-yes btn btn-success" href="<?php echo $this->getVoteUrl(5) ?>"><?php echo $this->__('Helpful') ?></a>
                                <a class="kb-helpful-no btn btn-danger" href="<?php echo $this->getVoteUrl(1) ?>"><?php echo $this->__('Not helpful') ?></a>
                            <?php else: ?><?php if ($this->getVoteResult() == 5): ?><?php if ($_article->getPostiveVoteNum() > 1): ?><?php echo $this->__('You and %s people found this helpful.', $_article->getPostiveVoteNum()) ?><?php else: ?><?php echo $this->__('You found this helpful.') ?><?php endif ?><?php endif ?><?php endif ?>
                        </div>
                    <?php endif ?>

                </div>
            </div>

        </div>
    </div>
</article>
<script>
    jQuery(document).ready(function () {

        jQuery(".tabs li a").click(function (event) {
            event.preventDefault();
            jQuery(".tabs li a").removeClass("active");
            jQuery(this).addClass("active");
            jQuery(".tab-content").hide();
            console.log(jQuery(this).attr("href"));
            jQuery(jQuery(this).attr("href")).show();
        });


        jQuery("body").scrollspy({
            target: ".kb-article-sidebar",
            offset: 70
        });

        jQuery('.kb-article-sidebar').affix({
            offset: {
                top: function () {
                    return (this.top = jQuery('#kb-article-sidebar-outer').offset().top)
                }
            }
        });


        var MqL = 768;
        var scrollTimer, wasTooBig = 0,
            lastScrollFireTime = 0;

        jQuery(window).on('resize', function () {
            jQuery('.kb-article-sidebar').affix('checkPosition');
            (!window.requestAnimationFrame) ? setTimeout(ev_moveNavigation, 10) : window.requestAnimationFrame(ev_moveNavigation);
        });
        jQuery(window).on('scroll', function () {

            var minScrollTime = 50;
            var now = new Date().getTime();
            var sidebar_element_height = jQuery('.kb-article-sidebar').outerHeight();
            var footer_height = jQuery('#elevate-footer').outerHeight();
            var newsletter_wrapper_height = jQuery('#home-newsletter').outerHeight();
            var page_bottom_height = footer_height + newsletter_wrapper_height + 17;

            function processScroll() {
                var current_pos = document.documentElement.scrollTop;
                var total_page_height = document.documentElement.scrollHeight;
                var total_height_for_calc = current_pos + page_bottom_height + sidebar_element_height;
                if (total_height_for_calc > total_page_height) {
                    //console.log("Too big!");
                    if (ev_checkWindowWidth() === true) {
                        // Desktop
                        console.log('ProcessScroll ev_checkWindowWidth desktop');

                        jQuery('.kb-article-sidebar').removeClass('affix');
                        wasTooBig = 1;
                    }

                }
                if (total_height_for_calc < total_page_height & wasTooBig === 1) {
                    //console.log("Not too big!");
                    jQuery('.kb-article-sidebar').addClass('affix');
                    wasTooBig = 0;
                }
            }

            if (!scrollTimer) {
                if (now - lastScrollFireTime > (3 * minScrollTime)) {
                    processScroll(); // fire immediately on first scroll
                    lastScrollFireTime = now;
                }
                scrollTimer = setTimeout(function () {
                    scrollTimer = null;
                    lastScrollFireTime = new Date().getTime();
                    processScroll();
                }, minScrollTime);
            }
        });
        jQuery('.kb-article-sidebar').on('activate.bs.scrollspy', function () {
            var activeitem = jQuery('.kb-article-tg-list-pri li.active');
            //console.log(activeitem);
            if (jQuery(activeitem).hasClass('kb-article-tg-list-outer')) {

                var data_parent_name = jQuery(activeitem).attr('data-parent-name');
                var itemstohide = jQuery('.kb-article-tg-list-inner[data-section-parent]');
                var itemstoshow = jQuery('.kb-article-tg-list-inner[data-section-parent="' + data_parent_name + '"]');
                jQuery.each(itemstohide, function (index, value) {
                    jQuery(value).hide();
                });
                jQuery.each(itemstoshow, function (index, value) {
                    jQuery(value).show();
                });
            }

            if (jQuery(activeitem).hasClass('kb-article-tg-list-inner')) {
                //console.log('list inner');
                var data_section_parent = jQuery(activeitem).attr('data-section-parent');
                jQuery(activeitem).parent().find('[data-section-parent="' + data_section_parent + '"]').show();

            }
        });
        jQuery('.kb-article-tg-list-outer').click(function () {
            var selected = jQuery(this);
            var data_parent_name = jQuery(this).attr('data-parent-name');

            // FInd all LI with attribute and show
            // if Active class goes onto another outer li , then trigger hide.
            var itemstoshow = jQuery('.kb-article-tg-list-inner[data-section-parent="' + data_parent_name + '"]');
            var itemstohide = jQuery('.kb-article-tg-list-inner[data-section-parent]');

            jQuery.each(itemstohide, function (index, value) {
                jQuery(value).hide();
            });

            jQuery.each(itemstoshow, function (index, value) {
                jQuery(value).show();
            });

            if (data_parent_name = jQuery(this).find("[data-section-parent='" + data_parent_name + "']").is(':visible')) {
                jQuery('#kb-article-tg-list-outer').slideUp();
                jQuery('#kb-article-tg-title .open-close-sidebaritem i').removeClass('fa-minus').addClass('fa-plus');
            } else {
                jQuery('#kb-article-tg-list-outer').slideDown();
                jQuery('#kb-article-tg-title .open-close-sidebaritem i').removeClass('fa-plus').addClass('fa-minus');
            }


        });

        jQuery('.kb-article-sidebar').on('affix.bs.affix', function () {
            ev_recalcaffixwidth();
        });
        jQuery('.kb-article-sidebar').on('affix-top.bs.affix', function () {

            jQuery('.kb-article-sidebar').css('width', '');
        });

        function ev_recalcaffixwidth() {
            var windowcheck = ev_checkWindowWidth();
            var size_element = jQuery('#kb-article-sidebar-outer').width();
            console.log("Recalc Affix Width");
            console.log(size_element);
            if (windowcheck === true) {
                jQuery('.kb-article-sidebar').css('width', size_element + 'px');
            } else {
                jQuery('.kb-article-sidebar').css('width', '');
                jQuery('.kb-article-sidebar').css('width', '100%;');
            }
        }

        function ev_checkWindowWidth() {
            //check window width (scrollbar included)
            var e = window,
                a = 'inner';
            if (!('innerWidth' in window)) {
                a = 'client';
                e = document.documentElement || document.body;
            }

            var width = e[a + 'Width'];

            if (width >= MqL) {
                return true;
            } else {

                return false;
            }
        }

        function ev_moveNavigation() {
            var desktop = ev_checkWindowWidth();

            if (desktop === true) {
                jQuery('.kb-article-sidebar').affix('checkPosition');
                ev_openuparticlesidebar();
                ev_recalcaffixwidth();


                var i = 1;
                jQuery('.tab-content').each(function (i, obj) {

                    jQuery("#tab-" + i).appendTo(".kb-article-sections");
                    //this is for the sub sections
                    jQuery("#tab-" + i + "_" + i).appendTo(".kb-article-sections");
                    i++;
                });


            }

            if (desktop === false) {
                jQuery('.kb-article-sidebar').affix('checkPosition');
                jQuery('#kb-article-tg-list-outer').hide();
                ev_closeuparticlesidebar();
                ev_recalcaffixwidth();

                var i = 1;
                jQuery('.tab-content').each(function (i, obj) {

                    jQuery("#tab-" + i).appendTo("#ultab-" + i);
                    //this is for the sub sections
                    jQuery("#tab-" + i + "_" + i).appendTo("#ultab-" + i);
                    i++;
                });


            }
        }

        function ev_openuparticlesidebar() {
            jQuery('#kb-article-tg-list-outer').slideDown();
            jQuery('#kb-article-tg-title .open-close-sidebaritem i').removeClass('fa-plus').addClass('fa-minus');
            jQuery('#kb-article-sidebar-outer').addClass('opened-up').removeClass('closed-up');
        }

        function ev_closeuparticlesidebar() {
            jQuery('#kb-article-tg-list-outer').slideUp();
            jQuery('#kb-article-tg-title .open-close-sidebaritem i').removeClass('fa-minus').addClass('fa-plus');
            jQuery('#kb-article-sidebar-outer').removeClass('opened-up').addClass('closed-up');
        }

        jQuery('.kb-article-tg-title').click(function () {
            var selected = jQuery(this);
            if (jQuery('#kb-article-tg-list-outer').is(':visible')) {
                ev_closeuparticlesidebar();
            } else {
                ev_openuparticlesidebar();
            }


        });

        ev_moveNavigation();
    });

</script>
