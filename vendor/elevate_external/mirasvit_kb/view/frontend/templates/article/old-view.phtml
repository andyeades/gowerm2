<?php
/** @var \Mirasvit\Kb\Block\Article\View $block */
$article = $block->getArticleByRepo();
$article_id = $article->getArticleId();
$article_categories = $block->getArticle()->getCategories();
$tags    = $block->getTags();
$articlesections_obj = $block->getArticleSections($article_id);
$articlesections = $articlesections_obj->getItems();

$article_header_image = '/media/wysiwyg/kbarticles/header-images/'.$article->getArticleHeaderImage();
$article_title = $article->getName();

$helper = $block->getHelper();
//$currentUrl = $this->helper('core/url')->getCurrentUrl();

?>

<?php // $block->getChildHtml('kb.search.form') ?>

<?php // $block->getKbPageTitle() ?>


<article class="kb-article-view-article">
    <header class="kb-article-header">
        <div class="kb-article-header-image" style="background:linear-gradient(rgba(0,107,127,.3),rgba(0,107,127,.3)),url(<?php echo $article_header_image;?>) no-repeat 50%; background-size:cover;">
            <div class="container">
                <div class="row">
                    <div class="col-xs-12">
                        <div class="flexbox-container">
                            <h1><?php echo $article->getName() ?></h1>
                        </div>
                    </div>
                </div>

                <?php
                 $disable_cat_and_share = 1;
                     if ($disable_cat_and_share != 1 ) { ?>
                <div class="row">
                    <div class="col-xs-12 col-sm-6">
                        <div class="kb-categories">
                            <?php $disable_category = 1; ?>
                            <?php if ($disable_category != 1 ) { ?>
                                <?php echo 'Categories:' ?>
                                <?php foreach ($categories as $category) { ?>
                                    <a class="label happybeds-label" href="<?php echo $category->getUrl() ?>"><?php echo $category->getName() ?></a>
                                <?php } ?>
                            <?php } ?>
                        </div>
                    </div>
                    <div class="col-xs-12 col-sm-6">
                        <div class="share-this-block">
                            <div class="share-this-block-inner">
                                <?php //$companyname = Mage::app()->getWebsite()->getName(); ?>
                                <?php $companyname = ''; ?>
                                <?php $emailsubjecttext = "Check Out the " .$article_title . " on the " . $companyname . " Website"; ?>
                                <?php $emailmailto = rawurlencode($emailsubjecttext); ?>
                                <?php //$emailbody = rawurlencode($currentUrl); ?>
                                <?php $emailbody = ''; ?>

                                <?php $linktext = $article_title; ?>
                                <?php $the_link = urlencode($linktext); ?>
                                <?php $the_title = urlencode($article_title); ?>
                                <?php //$the_url = urlencode($currentUrl); ?>
                                <?php $the_url = ''; ?>
                                <?php $the_image_url = urlencode($article_header_image); ?>
                                <?php

                                $email_a_friend_on = 0;
                                $pinterest_on = 0;

                                ?>

                                <div class="share-this-left">
                                    <i class="share-this-ico fa fa-3x fa-share-alt"></i>
                                    <div class="share-this-title">Share This</div>
                                </div>
                                <div class="share-icons">
                                    <?php if ($email_a_friend_on == 1) { ?>

                                        <a class="share-ico-mail" href="<?php //echo $this->helper('catalog/product')->getEmailToFriendUrl($_product) ?>"><i class="fa fa-envelope"></i></a>
                                    <?php } else { ?>
                                        <a target="_blank" href="mailto:?subject=<?php echo $emailmailto; ?>&body=<?php echo $emailbody; ?>" class="share-ico-mail"><i class="fa fa-envelope"></i></a>
                                    <?php } ?>
                                    <a target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=<?php echo $the_url; ?>" class="soc-ico-fb share-ico-facebook"><i class="fa fa-facebook-f"></i></a>
                                    <?php if ($pinterest_on == 1) { ?>
                                        <a target="_blank" href="http://pinterest.com/pin/create/button/?url=<?php echo $the_url; ?>&media=<?php echo $the_image_url; ?>&description=<?php echo $the_title; ?> " class="pin-it-button" count-layout="horizontal"><i class="fa fa-pinterest"></i></a>
                                    <?php } ?>
                                    <a target="_blank" href="https://twitter.com/intent/tweet?text=<?php echo $the_link ?>&url=<?php echo $the_url ?>" class="soc-ico-twit share-ico-twitter"><i class="fa fa-twitter"></i></a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <?php } ?>
            </div>
        </div>
    </header>
    <div class="container">
        <div class="row">
            <div class="col-xs-12 col-sm-9">
                <div id="kb-article-view-inner" class="kb-article-view-inner">

                    <?php echo $article->getText() ?>
                    <div class="kb-article-sections">


                        <?php foreach ($articlesections as &$articlesection) { ?>




                            <?php $articlesection_data = $articlesection->getAllData(); ?>
                            <?php $url_to_output = $block->getSectionUrl($articlesection_data['asec_name']); ?>
                            <div class="kb-article-section-inner">
                                <h2 id="<?php echo $url_to_output; ?>"><?php echo $articlesection_data['asec_name']; ?></h2>
                                <?php echo $articlesection_data['asec_value']; ?>
                                <?php
                                $articlesection_id = $articlesection_data['articlesection_id'];
                                $articlesubsections = $block->getArticleSubSections($articlesection_id);
                                ?>

                            </div>
                        <?php } ?>




                    </div>
            </div>
            <div id="kb-article-sidebar-outer" class="opened-up col-xs-12 col-sm-3">
                <div class="kb-article-sidebar">
                    <div class="kb-article-tg">
                        <div id="kb-article-tg-title" class="kb-article-tg-title">
                            In this guide <div id="inthisguide-preview">(PREVIEW MODE)</div>
                            <div class="open-close-sidebaritem"><i class="fa fa-minus"></i></div>
                        </div>
                        <div id="kb-article-tg-list-outer">

                            <ul class="kb-article-tg-list-pri nav">
                                <?php
                                foreach ($articlesections as $articlesection) {



                                    $articlesection_data = $articlesection->getAllData();

                                    $url_to_output = $block->getSectionUrl($articlesection_data['asec_name']);


                                    $articlesection_id = $articlesection_data['articlesection_id'];
                                    $articlesubsections = $block->getArticleSubSections($articlesection_id);


                                    $asubsec_count = $articlesubsections->getTotalCount();

                                    if ($asubsec_count > 0) {
                                        $parent_name = $url_to_output;
                                    }
                                    ?>

                                    <li class="kb-article-tg-list-outer <?php if ($asubsec_count > 0) { echo 'kb-article-tg-list-outer-with-inners';}?>"<?php if ($asubsec_count > 0) { echo 'data-parent-name="'.$parent_name.'"';}?>>
                                        <a href="#<?php echo $url_to_output; ?>" class="kb-article-tg-list-openclose">
                                            <?php echo $articlesection_data['asec_name']; ?>
                                        </a>
                                    </li>
                                    <?php if ($asubsec_count > 0) { ?>
                                        <?php foreach ($articlesubsections as $articlesubsection) { ?>

                                            <?php $articlesection_sub_data = $articlesubsection->getAllData(); ?>
                                            <?php $url_to_output = $block->getSectionUrl($articlesection_sub_data['asecsub_name']); ?>

                                            <li class="kb-article-tg-list-inner" data-section-parent="<?php echo $parent_name;?>">

                                                <a href="#<?php echo $url_to_output;?>"><?php echo $articlesection_sub_data['asecsub_name']; ?></a>

                                            </li>

                                        <?php } ?>
                                    <?php } ?>



                                <?php } ?>
                            </ul>

                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
</article>












<?php
/*

if ($block->getCommentProvider() == 'local_comments') {
    $block->getChildHtml('article.comment.listing');
}
 */
 ?>

<script>

    jQuery(document).ready(function() {

        jQuery("body").scrollspy({
            target: ".kb-article-sidebar",
            offset: 70
        });

        jQuery('.kb-article-sidebar').affix({
            offset: {
                top: function () {
                    return (this.top = jQuery('#kb-article-sidebar-outer').offset().top)
                }
            }
        });


        var MqL = 992;
        var scrollTimer, wasTooBig = 0, lastScrollFireTime = 0;

        jQuery(window).on('resize', function(){
            jQuery('.kb-article-sidebar').affix('checkPosition');
            (!window.requestAnimationFrame) ? setTimeout(ev_moveNavigation, 10) : window.requestAnimationFrame(ev_moveNavigation);
        });
        jQuery(window).on('scroll', function() {

            var minScrollTime = 50;
            var now = new Date().getTime();
            var sidebar_element_height = jQuery('.kb-article-sidebar').outerHeight();
            var footer_height = jQuery('#elevate-footer').outerHeight();
            var newsletter_wrapper_height = jQuery('#home-newsletter').outerHeight();
            var page_bottom_height = footer_height + newsletter_wrapper_height + 17;

            function processScroll() {
                var current_pos = document.documentElement.scrollTop;
                var total_page_height = document.documentElement.scrollHeight;
                var total_height_for_calc = current_pos + page_bottom_height + sidebar_element_height;
                if (total_height_for_calc > total_page_height) {
                    //console.log("Too big!");
                    if (ev_checkWindowWidth() === true) {
                        // Desktop
                        console.log('ProcessScroll ev_checkWindowWidth desktop');

                        jQuery('.kb-article-sidebar').removeClass('affix');
                        wasTooBig = 1;
                    }

                }
                if (total_height_for_calc < total_page_height & wasTooBig === 1) {
                    //console.log("Not too big!");
                    jQuery('.kb-article-sidebar').addClass('affix');
                    wasTooBig = 0;
                }
            }

            if (!scrollTimer) {
                if (now - lastScrollFireTime > (3 * minScrollTime)) {
                    processScroll();   // fire immediately on first scroll
                    lastScrollFireTime = now;
                }
                scrollTimer = setTimeout(function() {
                    scrollTimer = null;
                    lastScrollFireTime = new Date().getTime();
                    processScroll();
                }, minScrollTime);
            }
        });
        jQuery('.kb-article-sidebar').on('activate.bs.scrollspy', function () {
            var activeitem = jQuery('.kb-article-tg-list-pri li.active');
            //console.log(activeitem);
            if (jQuery(activeitem).hasClass('kb-article-tg-list-outer')) {

                var data_parent_name = jQuery(activeitem).attr('data-parent-name');
                var itemstohide = jQuery('.kb-article-tg-list-inner[data-section-parent]');
                var itemstoshow = jQuery('.kb-article-tg-list-inner[data-section-parent="'+ data_parent_name +'"]');
                jQuery.each(itemstohide, function(index,value){
                    jQuery(value).hide();
                });
                jQuery.each(itemstoshow, function(index,value){
                    jQuery(value).show();
                });
            }

            if (jQuery(activeitem).hasClass('kb-article-tg-list-inner')) {
                //console.log('list inner');
                var data_section_parent = jQuery(activeitem).attr('data-section-parent');
                jQuery(activeitem).parent().find('[data-section-parent="'+ data_section_parent +'"]').show();

            }
        });
        jQuery('.kb-article-tg-list-outer').click(function () {
            var selected = jQuery(this);
            var data_parent_name = jQuery(this).attr('data-parent-name');

            // FInd all LI with attribute and show
            // if Active class goes onto another outer li , then trigger hide.
            var itemstoshow = jQuery('.kb-article-tg-list-inner[data-section-parent="'+ data_parent_name +'"]');
            var itemstohide = jQuery('.kb-article-tg-list-inner[data-section-parent]');

            jQuery.each(itemstohide, function(index,value){
                jQuery(value).hide();
            });

            jQuery.each(itemstoshow, function(index,value){
                jQuery(value).show();
            });

            if (data_parent_name = jQuery(this).find("[data-section-parent='"+ data_parent_name +"']").is(':visible')) {
                jQuery('#kb-article-tg-list-outer').slideUp();
                jQuery('#kb-article-tg-title .open-close-sidebaritem i').removeClass('fa-minus').addClass('fa-plus');
            } else {
                jQuery('#kb-article-tg-list-outer').slideDown();
                jQuery('#kb-article-tg-title .open-close-sidebaritem i').removeClass('fa-plus').addClass('fa-minus');
            }


        });

        jQuery('.kb-article-sidebar').on('affix.bs.affix', function () {
            ev_recalcaffixwidth();
        });
        jQuery('.kb-article-sidebar').on('affix-top.bs.affix', function () {

            jQuery('.kb-article-sidebar').css('width','');
        });

        function ev_recalcaffixwidth() {
            var windowcheck = ev_checkWindowWidth();
            var size_element = jQuery('#kb-article-sidebar-outer').width();
            console.log("Recalc Affix Width");
            console.log(size_element);
            if (windowcheck === true) {
                jQuery('.kb-article-sidebar').css('width',size_element +'px');
            } else {
                jQuery('.kb-article-sidebar').css('width','');
                jQuery('.kb-article-sidebar').css('width','100%;');
            }
        }

        function ev_checkWindowWidth() {
            //check window width (scrollbar included)
            var e = window,
                a = 'inner';
            if (!('innerWidth' in window )) {
                a = 'client';
                e = document.documentElement || document.body;
            }

            var width =  e[ a+'Width' ];

            if ( width >= MqL ) {
                return true;
            } else {

                return false;
            }
        }
        function ev_moveNavigation() {
            var desktop = ev_checkWindowWidth();

            if (desktop === true) {
                jQuery('.kb-article-sidebar').affix('checkPosition');
                ev_openuparticlesidebar();
                ev_recalcaffixwidth();
            }

            if (desktop === false) {
                jQuery('.kb-article-sidebar').affix('checkPosition');
                jQuery('#kb-article-tg-list-outer').hide();
                ev_closeuparticlesidebar();
                ev_recalcaffixwidth();
            }
        }

        function ev_openuparticlesidebar() {
            jQuery('#kb-article-tg-list-outer').slideDown();
            jQuery('#kb-article-tg-title .open-close-sidebaritem i').removeClass('fa-plus').addClass('fa-minus');
            jQuery('#kb-article-sidebar-outer').addClass('opened-up').removeClass('closed-up');
        }
        function ev_closeuparticlesidebar() {
            jQuery('#kb-article-tg-list-outer').slideUp();
            jQuery('#kb-article-tg-title .open-close-sidebaritem i').removeClass('fa-minus').addClass('fa-plus');
            jQuery('#kb-article-sidebar-outer').removeClass('opened-up').addClass('closed-up');
        }
        jQuery('.kb-article-tg-title').click(function () {
            var selected = jQuery(this);
            if (jQuery('#kb-article-tg-list-outer').is(':visible')) {
                ev_closeuparticlesidebar();
            } else {
                ev_openuparticlesidebar();
            }


        });

        ev_moveNavigation();
    });


</script>
